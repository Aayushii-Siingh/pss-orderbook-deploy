pipeline {
  agent {
    kubernetes {
      yaml """\
        apiVersion: v1
        kind: Pod
        metadata:
          labels:
            builder: promotion
        spec:
          serviceAccountName: jenkins-agent
          containers:
          - name: awscli
            image: amazon/aws-cli
            command:
            - cat
            tty: true
      """.stripIndent()
    }
  }
  stages {
    stage('Promote to Production') {
      steps {
        script {
          for (int teamNum = 1; teamNum <= 40; teamNum++) {
            container(name: 'awscli') {
              def formattedTeamNum = String.format("%02d", teamNum)
              env.imageAPIDevName = "c500team${formattedTeamNum}api-dev-"
              env.imageAPIProdName = "c500team${formattedTeamNum}api-prod-"
              env.imageDBDevName = "c500team${formattedTeamNum}db-dev-"
              env.imageDBProdName = "c500team${formattedTeamNum}db-prod-"
              env.imageFEDevName = "c500team${formattedTeamNum}fe-dev-"
              env.imageFEProdName = "c500team${formattedTeamNum}fe-prod-"

              sh '''
                set -x

                export AWS_DEFAULT_REGION=us-east-1
                
                # Get the latest image tag for API
                latestAPITag=$(aws ecr describe-images --repository-name production-support-course --query 'images[?contains(imageTags, `${imageAPIDevName}`)].imageTags | [0]' --output text)
                imageAPIProd="${imageAPIProdName}${latestAPITag}"
                echo "Latest API Tag: ${latestAPITag}"

                # Get the latest image tag for DB
                latestDBTag=$(aws ecr describe-images --repository-name production-support-course --query 'images[?contains(imageTags, `${imageDBDevName}`)].imageTags | [0]' --output text)
                imageDBProd="${imageDBProdName}${latestDBTag}"
                echo "Latest DB Tag: ${latestDBTag}"

                # Get the latest image tag for Front End
                latestFETag=$(aws ecr describe-images --repository-name production-support-course --query 'images[?contains(imageTags, `${imageFEDevName}`)].imageTags | [0]' --output text)
                imageFEProd="${imageFEProdName}${latestFETag}"
                echo "Latest Front End Tag: ${latestFETag}"

                # Check API
                if [ -z "${latestAPITag}" ]
                then
                  echo "No images found for ${imageAPIProdName}"
                  exit 1
                fi

                # Check DB
                if [ -z "${latestDBTag}" ]
                then
                  echo "No images found for ${imageDBProdName}"
                  exit 2
                fi
                
                # Check Front End
                if [ -z "${latestFETag}" ]
                then
                  echo "No images found for ${imageFEProdName}"
                  exit 3
                fi

                # Check API
                if [ $(aws ecr describe-images --repository-name production-support-course | grep "${imageAPIProd}" | wc -l) -eq 0 ]
                then
                  # We don't have prod so tag Dev to prod
                  if ! aws ecr put-image --repository-name production-support-course --image-tag ${imageAPIProd} --image-manifest "$(aws ecr batch-get-image --repository-name production-support-course --image-ids imageTag=${imageAPIDevName}${latestAPITag} --query 'images[].imageManifest' --output text)"
                  then
                    exitvalue=1
                  fi
                fi

                # Check DB
                if [ $(aws ecr describe-images --repository-name production-support-course | grep "${imageDBProd}" | wc -l) -eq 0 ]
                then
                  # We don't have prod so tag Dev to prod
                  if ! aws ecr put-image --repository-name production-support-course --image-tag ${imageDBProd} --image-manifest "$(aws ecr batch-get-image --repository-name production-support-course --image-ids imageTag=${imageDBDevName}${latestDBTag} --query 'images[].imageManifest' --output text)"
                  then
                    exitvalue="${exitvalue}2"
                  fi
                fi
                
                # Check Front End
                if [ $(aws ecr describe-images --repository-name production-support-course | grep "${imageFEProd}" | wc -l) -eq 0 ]
                then
                  # We don't have prod so tag Dev to prod
                  if ! aws ecr put-image --repository-name production-support-course --image-tag ${imageFEProd} --image-manifest "$(aws ecr batch-get-image --repository-name production-support-course --image-ids imageTag=${imageFEDevName}${latestFETag} --query 'images[].imageManifest' --output text)"
                  then
                    exitvalue=3
                  fi
                fi

                case ${exitvalue} in
                  0) echo "Update OK"
                     ;;
                  1) echo "API failed to push to repository"
                     ;;
                  2) echo "DB failed to push to repository"
                     ;;
                  3) echo "Front End failed to push to repository"
                     ;;
                  12) echo "API and DB failed to push to repository"
                      ;;
                  13) echo "API and Front End failed to push to repository"
                      ;;
                  23) echo "DB and Front End failed to push to repository"
                      ;;
                  123) echo "All images failed to push to repository"
                       ;;
                esac

                exit ${exitvalue}
              '''
            }
          }
        }
      }
    }
  }
  environment {
    ECR_REPO = '108174090253.dkr.ecr.us-east-1.amazonaws.com/production-support-course'
  }
}
